.. sectionauthor:: Дмитрий Барышников <dmitry.baryshnikov@nextgis.ru>

.. _ngogportal_editor:

Инструкция по размещению геоданных на портале
==============================================

Техническое описание
----------------------------------------------

Система состоит из двух веб-движков: :program:`CKAN` и :program:`NextGIS Web`. 
Эти серверные решения, к которым есть свои инструкции, при необходимости вы 
можете их найти в сети, но для размещения данных - достаточно данной инструкции.

:program:`CKAN` - веб-сервис для хостинга "открытых данных". 
:term:`Открытые данные` - это такое понятие, которое имеет законодательное 
определение. Вкратце - это данные в машинно-читаемом формате, размещаемые в сети, 
имеющие открытую лицензию, позволяющие их всем скачивать.
:program:`NextGIS Web` - это веб-сервис для хостинга "геоданных". :term:`Геоданные` - это 
файлы (или базы данных), хранящие объекты с географическими координатами (как 
точками, так и линиями или фигурами). 
Изначально :program:`CKAN` мог хранить только табличные данные. При разработке 
портала его интегрировали с :program:`NextGIS Web` так, что он теперь может 
показывать геоданные - в нём появились карты, и возможность добавлять ссылки на 
разные форматы геоданных. Пользователь работает только с веб-интерфейсом 
:program:`CKAN`. В :program:`CKAN` хранятся ссылки на разные наборы данных, 
которые ведут в :program:`NextGIS Web`. Физически сами данные хранятся в 
:program:`NextGIS Web`. Туда грузится файл, а он предоставляет ссылки на 
скачивание или получение данных в разных форматах. Эти ссылки и размещаются в 
:program:`CKAN`. А оператор работает с веб-интерфейсом :program:`CKAN` и 
:program:`NextGIS Web`.

Краткое описание, для тех кто уже работал с :program:`NextGIS Web`
------------------------------------------------------------------

1. Взять файл в GeoJSON.
2. Загрузить в :program:`NextGIS Web`.
3. Создать в :program:`CKAN` набор данных, с названиями, описаниями и лицензией.
4. В :program:`CKAN` в наборы данных вставить ссылки на разные форматы данных, которые взять из :program:`NextGIS Web`.
5. Теперь в :program:`CKAN` можно будет смотреть геоданные на карте, и скачивать.

Размещение геоданных на портале
-------------------------------------------------

Вам потребуется:

1. Файл геоданных. Система принимает файлы в форматах :term:`GeoJSON`, :term:`ESRI Shapefile` 
   (в zip-архиве). Если нет особых требований, то рекомендуется сохранять их в 
   формате GeoJSON - с ним удобнее работать. Для подготовки файлов данных можно 
   использовать NextGIS QGIS, или другие программы. Эти форматы широко 
   распространены, и с ними работает множество :term:`ГИС`.
2. Адрес веб-интерфейса :program:`CKAN`.
3. Адрес веб-интерфейса :program:`NextGIS Web`.
4. Логин и пароль от :program:`CKAN`.
5. Логин и пароль от :program:`NextGIS Web`.
6. Название лицензии, под которой публикуются данные. Если лицензию не указать, 
   то формально данные не будут считаться открытыми.

Термины:

В :program:`NextGIS Web` данные делятся по каталогам - они называются "группы 
ресурсов", в группах ресурсов лежат слои.
В :program:`CKAN` лежат массивы данных, в массивах лежат данные. Как видим, 
структура похожая, только сущности называются по-разному.

1. Зайдите в веб-интерфейс :program:`NextGIS Web`. Введите логин и пароль. 
   Если интерфейс не спросил логин - посмотрите вправо-вверх, какое имя 
   пользователя написано. Если он не ваш - залогиньтесь.

.. figure:: _static/ogportalNGWLogin.png
   :name: ogportalNGWLogin
   :align: center
   :width: 15cm

   Веб-интерфейс NextGIS Web. 1 - ссылка на авторизацию.


2. Посредине экрана находится список "Дочерние ресурсы". В нём зайдите в группу ресурсов "Открытые данные" --> "Векторные данные". Зайтите 
   там в нужный раздел, или создайте новый ссылкой "Создать ресурс" --> "Группа ресурсов".

.. figure:: _static/ogportalNGWGroups.png
   :name: ogportalNGWGroups
   :align: center
   :width: 15cm

   Веб-интерфейс NextGIS Web. 1 - список групп ресурсов и слоёв. 2 - ссылки на создание ресурсов

3. Зайдите в нужную группу ресурсов, В блоке :guilabel:`Создать ресурс` нажмите 
   :guilabel:`Векторный слой`. В открывшемся окне введите Наименование. 
   Переключитесь на вкладку :guilabel:`Векторный слой`. 

.. figure:: _static/admin_layers_create_vector_layer_resourse_description.png
   :name: admin_layers_create_vector_layer_resourse_description
   :align: center
   :width: 16cm

   Окно добавления векторного слоя.

Укажите исходный файл (кнопка Выбрать, 
см. :numref:`admin_layers_create_vector_layer_upload`).  

.. figure:: _static/admin_layers_create_vector_layer_upload.png
   :name: admin_layers_create_vector_layer_upload
   :align: center
   :width: 16cm

   Окно загрузки векторного слоя.




В качестве исходного файла можно загружать следующие форматы: 

* ESRI Shapefile в ZIP-архиве;
* GeoJSON.

.. note:: 
   Файл должен быть в кодировке UTF-8.
   Во входном файле не должно быть невалидных геометрий (в QGIS соответствующий 
   инструмент должен выдавать пустой список невалидных геометрий), даты не должны 
   иметь значения NULL, не должно быть полей с названиями: *id (ID), type(TYPE), 
   source(SOURCE)*. Cистема координат геометрий должна распознается GDAL (вывод 
   gdalinfo должен содержать описание СК). 

4. Теперь нужно создать для этого слоя векторный стиль - он будет использоваться 
   для отображения по протоколу WMS. Зайдите в векторный слой. Нажмите ссылку 
   "Создать MapServer style". 


.. figure:: _static/ogportalNGWCreateVectorStyle1.png
   :name: ogportalNGWCreateVectorStyle1
   :align: center
   :width: 16cm



.. figure:: _static/ogportalNGWCreateVectorStyle2.png
   :name: ogportalNGWCreateVectorStyle2
   :align: center
   :width: 16cm

Введите то же наименование, что и у слоя. 
Нажмите 
   :guilabel:`Создать`. 


.. figure:: _static/ogportalNGWCreateVectorStyle3.png
   :name: ogportalNGWCreateVectorStyle3
   :align: center
   :width: 16cm

.. note::
   Стиль создастся с оформлением по умолчанию: все фигуры будут одного случайного 
   цвета. При необходимости настроить цвета и подписи - см. :ref:`ngw_style_create`.
   Однако эти стили возымеют действие только при подключении по WMS.

5. В наборе данных может быть один или несколько слоёв. Каждый слой раздаётся в 
   разных форматах. Для каждого набора данных делается так же по одному "сервису 
   WFS" и "сервису WFS", в которые помещаются все слои. 

.. figure:: _static/ogportalNGWCreateWFS1.png
   :name: ogportalNGWCreateWFS1
   :align: center
   :width: 16cm

После того, как вы добавили все слои в группу ресурсов перейдите в группу 
ресурсов, нажмите "Создать сервис WFS". 

.. figure:: _static/ogportalNGWCreateWFS2.png
   :name: ogportalNGWCreateWFS2
   :align: center
   :width: 16cm

Введите его название - такое же как у группы, с добавлением "WFS-сервис". 
Перейдите на вкладку :guilabel:`WFS-сервис`. 

.. figure:: _static/ogportalNGWCreateWFS3.png
   :name: ogportalNGWCreateWFS3
   :align: center
   :width: 16cm

   Список ресурсов

Нажмите кнопку :guilabel:`Добавить`. Откроется список - в нём дерево всех ресурсов. 
Выберите в этом списке слой, который вы добавили на предыдущем шаге (как на картинке - выделите строку со значком папки.  
Нажмите :guilabel:`Ок`. Повторите добавление для всех новых слоёв.


.. figure:: _static/ogportalNGWCreateWFS4.png
   :name: ogportalNGWCreateWFS4
   :align: center
   :width: 16cm

Затем выберите в списке слева каждый слой, присвойте ему ключ латинскими буквами. 

Таким же образом (:numref:`ogportalNGWCreateWFS1`, :numref:`ogportalNGWCreateWFS2`, :numref:`ogportalNGWCreateWFS3`, :numref:`ogportalNGWCreateWFS4`) добавьте WMS-сервис, в него добавляйте не слои, а стили слоёв.

6. Зайдите в другой вкладке браузера в веб-интерфейс :program:`CKAN`. В нём 
   пользователи и операторы работают с одними и теми же страницами, отдельной 
   "админки" нету. Авторизуйтесь на сайте, и зайдите в раздел "Пакеты данных".


.. figure:: _static/ogportalCKANInterface1.png
   :name: ogportalCKANInterface1
   :align: center
   :width: 16cm

7. Зайдите в нужный пакет данных, или создайте новый кнопкой :guilabel:`Создать набор данных`.
8. На странице нужного пакета данных нажмите :guilabel:`Manage`, затем перейдите на вкладку :guilabel:`Ресурсы`.

9. В этот набор данных нужно добавить ссылки на скачивание данных в различных 
   форматах. Эти ссылки вам нужно скопировать из :program:`NextGIS Web`. Откройте в другой вкладке браузера в нём нужный 
   ресурс.    Для примера добавим GeoJSON, как наиболее распространённый формат. 

.. figure:: _static/ogportalADDGeoJSON.png
   :name: ogportalADDGeoJSON
   :align: center
   :width: 16cm

В :program:`NextGIS Web` откройте векторный слой.
Справа страницы найдите ссылку "Загрузить GeoJSON", нажмите на неё правой кнопкой мыши, нажмите :guilabel:`Скопировать адрес ссылки`.
В CKAN нажмите :guilabel:`Add new resource`.


.. figure:: _static/ogportalADDGeoJSON2.png
   :name: ogportalADDGeoJSON2
   :align: center
   :width: 16cm

В URL вставьте ссылку на скачивание GeoJSON.
В имя - введите название ресурса.
В формат - введите "GeoJSON", дождитесь, пока появится всплывающий список из одного элемента, и выберите в нём geojson.
Нажмите кнопку :guilabel:`Добавить`. :numref:`ogportalADDGeoJSON2`

Повторите данный пункт, добавив все форматы, перечисленные ниже:

Форматы
::::::::::::::::::::::::::::::


* :term:`GeoJSON` - В NextGIS WEB наведите мышью на ссылку "Загрузить GeoJSON". Нажмите правую кнопку --> Скопировать ссылку. Добавьте в :program:`CKAN` новый ресурс, добавьте ссылку, имя, укажите формат GeoJSON.
* JSON - В NextGIS WEB наведите мышью на ссылку "Представление JSON". Нажмите правую кнопку --> Скопировать ссылку. Добавьте в :program:`CKAN` новый ресурс, добавьте ссылку, имя, укажите формат JSON.
* :term:`CSV` - В NextGIS WEB наведите мышью на ссылку "Загрузить CSV". Нажмите правую кнопку --> Скопировать ссылку. Добавьте в :program:`CKAN` новый ресурс, добавьте ссылку, имя, укажите формат CSV.
* :term:`ESRI Shapefile` - В NextGIS WEB наведите мышью на ссылку "". Нажмите правую кнопку --> Скопировать ссылку. Добавьте в :program:`CKAN` новый ресурс, добавьте ссылку, имя, укажите формат .
* :term:`WFS` - один на набор данных. Откройте WFS-сервис в :program:`NextGIS Web`, скопируйте гиперссылку. Добавьте в :program:`CKAN` новый ресурс, добавьте ссылку, имя, укажите формат WFS. 
* :term:`WMS` - один на набор данных. Откройте WFS-сервис в :program:`NextGIS Web`, скопируйте гиперссылку. Добавьте в :program:`CKAN` новый ресурс, добавьте ссылку, имя, укажите формат WFS.

На этом операция размещения геоданных закончена. 


Как должны быть настроены права в :program:`NextGIS Web`
--------------------------------------------------------

.. todo:  фигура. Настройка прав у корневой группы ресурсов

.. todo:  фигура. Настройка прав у группы ресурсов ***

.. todo:  фигура. Настройка прав у группы ресурсов ***

У ниже лежащих групп ничего дополнительно настраивать не надо, там будет вот так:

.. todo: фигура. Настройка прав у группы ресурсов *** (или у слоя?)





Что выключать, если нужно убрать какие-то данные
-------------------------------------------------

#. В веб-интерфейсе :program:`CKAN` зайдите в ресурс, кнопку Manage, кнопку Удалить.
#. В веб-интерфейсе :program:`NextGIS Web` зайдите в ресурс. Вы можете удалить слой, в таком случае он удалится полностью, и восстановить его будет нельзя. Альтернативно, вы можете зайти в его настройки, и закрыть к нему доступ - см. http://docs.nextgis.ru/docs_ngweb/source/admin_tasks.html#access-rights
